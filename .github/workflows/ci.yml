name: CI Pipeline

permissions:
  contents: write
  pages: write
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U testuser"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_USER_URL: postgresql://testuser:testpass@localhost:5432/testdb
      DATABASE_TASKS_URL: postgresql://testuser:testpass@localhost:5432/testdb
      JWT_SECRET: test_secret
      NODE_ENV: test

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies (root workspaces)
        run: npm ci

      - name: Generate Prisma client (user-service)
        run: npx prisma generate --schema services/user-service/prisma/schema.prisma

      - name: Generate Prisma client (todo-service)
        run: npx prisma generate --schema services/todo-service/prisma/schema.prisma

      - name: Run migrations (user-service)
        env:
          DATABASE_URL: ${{ env.DATABASE_USER_URL }}
        run: npx prisma migrate deploy --schema services/user-service/prisma/schema.prisma

      - name: Run migrations (todo-service)
        env:
          DATABASE_URL: ${{ env.DATABASE_TASKS_URL }}
        run: npx prisma migrate deploy --schema services/todo-service/prisma/schema.prisma

      - name: Build jwt lib first
        run: npm run -w @backendrestapi/jwt build

      - name: Build user-service
        run: npm run -w user-service build

      - name: Build todo-service
        run: npm run -w todo-service build

      - name: Run tests
        env:
          DATABASE_USER_URL: ${{ env.DATABASE_USER_URL }}
          DATABASE_TASKS_URL: ${{ env.DATABASE_TASKS_URL }}
          JWT_SECRET: ${{ env.JWT_SECRET }}
        run: npm test --workspaces --if-present
      - name: Generate HTML reports (if configured in services)
        run: |
          # Try service-level scripts (won't fail the job if absent)
          npm run -w user-service test:html --if-present || echo "user-service test:html not present"
          npm run -w todo-service test:html --if-present || echo "todo-service test:html not present"
          # Try a root-level workspace html script if you created one
          npm run test:html --workspaces --if-present || echo "no root test:html workspace script"

      - name: Prepare consolidated reports folder
        run: |
          # create a clean publish folder
          rm -rf reports_publish consolidated_reports || true
          mkdir -p consolidated_reports
          # copy root-level reports into consolidated_reports (if any)
          if [ -d "./reports" ]; then
            # copy contents (not the folder itself) to consolidated_reports
            shopt -s dotglob || true
            cp -R ./reports/* consolidated_reports/ 2>/dev/null || true
          fi
          # copy reports from services into consolidated_reports/<service-name>/
          for svc in services/*; do
            if [ -d "$svc/reports" ]; then
              svcname=$(basename "$svc")
              mkdir -p "consolidated_reports/$svcname"
              cp -R "$svc/reports/"* "consolidated_reports/$svcname/" 2>/dev/null || true
            fi
          done
          # if there is nothing, create a small index to show no reports found
          mkdir -p reports_publish
          if [ "$(ls -A consolidated_reports 2>/dev/null || true)" != "" ]; then
            cp -R consolidated_reports/* reports_publish/ || true
          else
            echo "<html><body><h1>No reports generated</h1></body></html>" > reports_publish/index.html
          fi

      - name: Upload test reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports_publish

      - name: Deploy reports to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GH_PAGES_PAT }}
          publish_dir: ./reports_publish
          publish_branch: gh-pages
